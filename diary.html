<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:site_name" content="Hello, Rosaura Meowie!">
    <meta property="og:title" content="Hello, Rosaura Meowie!" />
    <meta property="og:description" content="A special letter for someone special!" />
    <meta property="og:image" content="/pink.png/" />
    <meta property="og:url" content="https://rosaura-letter.vercel.app/diary.html" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Hello, Rosaura Meowie!" />
    <meta name="twitter:description" content="A special letter for someone special!" />
    <meta name="twitter:image" content="/pink.png/" /> 
    <link rel="icon" href="pink.png" type="image/png">
    <title>Hello, Rosaura Meowie!</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

  <style>
    
    body {
      margin: 0;
      font-family: 'Courier New', monospace;
      background: #f3e9dc;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    h1 {
      color: #4e342e;
    }

    .controls {
      margin: 10px 0;
    }

    select, input[type="text"] {
      font-family: inherit;
      font-size: 16px;
      padding: 5px 10px;
      margin: 0 5px;
    }

    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      width: 100%;
      max-width: 700px;
      margin-bottom: 30px;
    }

    .day, .day-name {
      padding: 10px;
      background: #fff8dc;
      border: 1px solid #c4b89b;
      text-align: center;
      min-height: 100px;
      cursor: pointer;
      box-sizing: border-box;
      overflow: hidden;           /* Prevent overflow */
      max-height: 100px;        
    }

    .day-name {
      background: #e5d3b3;
      font-weight: bold;
      cursor: default;
    }

    .day:hover {
      background: #fceacb;
    }

    .has-note {
      font-weight: bold;
    }

    .today {
      border: 2px solid #d2691e;
    }

    .note-editor {
      background: #fff8dc;
      border: 1px solid #c4b89b;
      padding: 20px;
      width: 100%;
      max-width: 700px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }

     .note-title {
      white-space: nowrap;       
      overflow: hidden;           
      text-overflow: ellipsis;    
      max-width: 100%;            
      text-align: center;        
      line-height: 20px;          
      display: inline-block;     
      height: 20px;               
      width: 100%;           
    }


    .note-editor h2 {
      margin-top: 0;
    }

    textarea {
      width: 100%;
      height: 150px;
      margin: 10px 0;
      resize: vertical;
      font-family: inherit;
      font-size: 16px;
      background: transparent;
      border: 1px solid #d2b48c;
      padding: 10px;
      line-height: 1.5;
    }

    button {
      background: #d2b48c;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      font-family: inherit;
      cursor: pointer;
      border-radius: 5px;
    }

    button:hover {
      background: #bca27d;
    }

    .love {
      background-color: #ffe4e1 !important;
    }

    .important {
      background-color: #e0ffff !important;
    }

    .greetings {
      background-color: #f0f5ad !important;
    }
    .controls select, .controls input {
    font-size: 14 px; /* Adjust the font size as needed */
  }

  </style>
</head>
<body>

  <center>
    <h1 style="margin: 0; line-height: 1.2;">üìñ Dear Saura ·∞î</h1>
    <small style="display: block; margin: 0; font-size: 0.9em; margin-bottom: 15px;">Developed by: Martel</small>
  </center>
  
 

<div class="controls" style="margin-bottom: 30px;">
  <select id="monthSelect"></select>
  <select id="yearSelect"></select>
  <select id="filterSelect">
    <option value="">Filter by type</option>
    <option value="important">Important</option>
    <option value="love">Love</option>
    <option value="greetings">Greetings</option>
  </select>
  <input type="text" id="searchInput" placeholder="Search notes...">
</div>

<div class="calendar" id="calendar"></div>

<div class="note-editor" id="noteEditor" style="display:none;">
  <!-- This image will be dynamically updated -->
<img id="noteImagePreview" src="" alt="Note Image" style="max-width:100%; height:auto; max-height:200px;  display: block; object-fit:cover; float: right;  display:none; margin-bottom:10px;">

  <h2 id="noteTitle">Diary Entry</h2>
  <select id="noteType">
    <option value="">None</option>
    <option value="important">Important</option>
    <option value="love">Love</option>
    <option value="greetings">Greetings</option>
  </select>

  <input type="text" id="subject" placeholder="Subject" style="width:100%; margin: 10px 0; font-family: inherit; font-size: 16px; padding: 10px; border: 1px solid #d2b48c; background: transparent;">

  <input type="text" id="title" placeholder="Title" style="width:100%; margin: 10px 0; font-family: inherit; font-size: 16px; padding: 10px; border: 1px solid #d2b48c; background: transparent;">
  <textarea id="noteContent" placeholder="Write your thoughts..."></textarea>

  <input type="text" id="remarks" placeholder="Remarks" style="width:100%; margin: 10px 0; font-family: inherit; font-size: 16px; padding: 10px; border: 1px solid #d2b48c; background: transparent;">

  <input type="email" id="emailRecipient" placeholder="Recipient email (optional)" style="width:100%; margin: 10px 0; font-family: inherit; font-size: 16px; padding: 10px; border: 1px solid #d2b48c; background: transparent;">

  

  <input type="file" id="noteImage" accept="image/*" style="margin: 10px 0; font-family: inherit;">



  <button onclick="saveNote()" style=" display: block; object-fit:cover; float: right;">Save</button>
  <button onclick="clearNote()" style=" display: block; object-fit:cover; margin-right: 10px; float: right;">Clear</button>
</div>

<div id="saveModal" style="
  display: none;
  position: fixed;
  top: 20px; /* ‚¨ÖÔ∏è Changed from bottom to top */
  left: 50%;
  transform: translateX(-50%);
  background-color: #333;
  color: #fff;
  padding: 10px 20px;
  border-radius: 8px;
  z-index: 9999;
  opacity: 0.95;
  font-family: sans-serif;  
">
  ‚úÖ Note saved successfully!
</div>

<div id="emailSuccessModal" style="
  display: none;
  position: fixed;
  top: 65px; /* ‚¨ÖÔ∏è Changed from bottom to top */
  left: 50%;
  transform: translateX(-50%);
  background-color: #333;
  color: #fff;
  padding: 10px 20px;
  border-radius: 8px;
  z-index: 9999;
  opacity: 0.95;
  font-family: sans-serif;
">
  ‚úâÔ∏è Email sent successfully!
</div>

<div id="emailFailModal" style="
  display: none;
  position: fixed;
  top: 65px; /* ‚¨ÖÔ∏è Changed from bottom to top */
  left: 50%;
  transform: translateX(-50%);
  background-color: #333;
  color: #fff;
  padding: 10px 20px;
  border-radius: 8px;
  z-index: 9999;
  opacity: 0.95;
  font-family: sans-serif;
">
  ‚ùå Failed to send email.
</div>



<!-- Supabase CDN -->
<script>
  const supabaseUrl = 'https://rushdtpzxfnvobniswwm.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1c2hkdHB6eGZudm9ibmlzd3dtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzNjQ5OTUsImV4cCI6MjA2MTk0MDk5NX0.r9saS6lbP_rckgZboDg_bJd2Hy1VqfLEwS0k0AT07lE';
  const supabaseClient  = supabase.createClient(supabaseUrl, supabaseKey);

  const calendarEl = document.getElementById('calendar');
  const noteEditor = document.getElementById('noteEditor');
  const noteTitle = document.getElementById('noteTitle');
  const noteContent = document.getElementById('noteContent');
  const monthSelect = document.getElementById('monthSelect');
  const yearSelect = document.getElementById('yearSelect');
  const filterSelect = document.getElementById('filterSelect');
  const searchInput = document.getElementById('searchInput');
  const noteType = document.getElementById('noteType');

  const months = ["January", "February", "March", "April", "May", "June",
                  "July", "August", "September", "October", "November", "December"];
  const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

  for (let i = 0; i < 12; i++) {
    const opt = document.createElement('option');
    opt.value = i;
    opt.text = months[i];
    monthSelect.appendChild(opt);
  }

  const currentYear = new Date().getFullYear();
  for (let i = currentYear - 50; i <= currentYear + 50; i++) {
    const opt = document.createElement('option');
    opt.value = i;
    opt.text = i;
    yearSelect.appendChild(opt);
  }

  const today = new Date();
  monthSelect.value = today.getMonth();
  yearSelect.value = today.getFullYear();

  function clearNote() {
  noteContent.value = '';
  noteType.value = '';
  document.getElementById('emailRecipient').value = '';
  document.getElementById('remarks').value = '';
  document.getElementById('subject').value = '';
  document.getElementById('title').value = ''; // Clear title too
}

  async function renderCalendar() {
  calendarEl.innerHTML = '';
  const year = parseInt(yearSelect.value);
  const month = parseInt(monthSelect.value);
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const lastDay = daysInMonth; // ‚úÖ use real last day

  const filter = filterSelect.value;
  const searchTerm = searchInput.value.toLowerCase();

  const { data: notes, error } = await supabaseClient
    .from('diary_entries')
    .select('*')
    .gte('date', `${year}-${String(month + 1).padStart(2, '0')}-01`)
    .lte('date', `${year}-${String(month + 1).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`);

  if (error) {
    console.error("Failed to load notes:", error);
    return;
  }

  const now = new Date();
  const utc = now.getTime() + now.getTimezoneOffset() * 60000;
  const phNow = new Date(utc + 8 * 60 * 60 * 1000);
  const phYear = phNow.getFullYear();
  const phMonth = phNow.getMonth();
  const phDay = phNow.getDate();

  // Day headers
  daysOfWeek.forEach(day => {
    const header = document.createElement('div');
    header.className = 'day-name';
    header.textContent = day;
    calendarEl.appendChild(header);
  });

  // Blank cells before 1st day
  for (let i = 0; i < firstDay; i++) {
    const blank = document.createElement('div');
    calendarEl.appendChild(blank);
  }

  // Render each day
  for (let day = 1; day <= daysInMonth; day++) {
    const dateKey = formatDateKey(year, month, day);
    const noteData = notes.find(n => n.date === dateKey);
    const noteText = noteData?.text?.toLowerCase() || '';
    const noteColor = noteData?.color || '';

    let showNote = true;
    if ((filter && noteColor !== filter) || (searchTerm && !noteText.includes(searchTerm))) {
      showNote = false;
    }

    const cell = document.createElement('div');
    cell.className = 'day';
    cell.innerHTML = `<strong>${day}</strong>`;

    if (noteText && showNote) {
  cell.innerHTML += `<br><span style="font-size: 20px;">üìù</span>`;
  if (noteData.title) {
    // Wrap the title in a div with a class that will handle the text truncation
    cell.innerHTML += `<div class="note-title" style="font-size: 12px; margin-top: 4px;">${noteData.title}</div>`;
  }
  cell.classList.add('has-note');
  if (noteColor) cell.classList.add(noteColor);
}


    if (year === phYear && month === phMonth && day === phDay) {
      cell.classList.add('today');
    }

    cell.onclick = () => openNote(year, month, day, noteData);
    calendarEl.appendChild(cell);
  }
}


  function openNote(year, month, day, noteData = null) {
    const dateKey = formatDateKey(year, month, day);
    noteContent.value = noteData?.text || '';
    noteType.value = noteData?.color || '';
    noteEditor.style.display = 'block';
    noteTitle.textContent = `Diary - ${months[month]} ${day}, ${year}`;
    noteEditor.setAttribute('data-date', dateKey);

      // Get the image preview element
  const preview = document.getElementById('noteImagePreview');
  document.getElementById('title').value = noteData?.title || '';

  document.getElementById('remarks').value = noteData?.remarks || '';

  document.getElementById('subject').value = noteData?.subject || '';


  if (noteData?.image_url) {
    preview.src = noteData.image_url;
    preview.style.display = 'block';
  } else {
    preview.style.display = 'none'; // Hide if no image
    preview.src = '';
  }


    // If an email is present, set it as the value of the emailRecipient input
    if (noteData?.email) {
        document.getElementById('emailRecipient').value = noteData.email;
    } else {
        document.getElementById('emailRecipient').value = ''; // Ensure the field is clear if no email
    }
  }


  



  async function saveNote() {  

  const dateKey = noteEditor.getAttribute('data-date');
  const content = noteContent.value.trim();
  const color = noteType.value;
  const recipientEmail = document.getElementById('emailRecipient').value.trim();  // Capture the email input
  const imageFile = document.getElementById('noteImage').files[0];
  const title = document.getElementById('title').value.trim();  // Capture the email input
  const remarks = document.getElementById('remarks').value.trim();
  const subject = document.getElementById('subject').value.trim();
  
   // ‚úÖ Fetch existing note (must come AFTER dateKey is defined)
   let { data: existingNote, error: fetchError } = await supabaseClient
    .from('diary_entries')
    .select('image_url')
    .eq('date', dateKey)
    .maybeSingle();

  if (fetchError && fetchError.code !== 'PGRST116') {
    console.error("Error fetching existing note:", fetchError.message);
  }

  let imageUrl = existingNote?.image_url || '';


  // ‚úÖ Upload image if file selected
  if (imageFile) {
    const fileExt = imageFile.name.split('.').pop();
    const fileName = `${dateKey}.${fileExt}`;
    // const filePath = `diary-images/${dateKey}-${imageFile.name}`;
    const filePath = `images/${dateKey}-${imageFile.name}`; // ‚Üê matches upload path

    const { error: uploadError } = await supabaseClient.storage
    .from('images')
  .upload(filePath, imageFile, {
    cacheControl: '3600',
    upsert: true,
    contentType: imageFile.type,
  });

    if (uploadError) {
      console.error("‚ùå Image upload failed:", uploadError);
      return alert("‚ùå Image upload failed: " + uploadError.message);
    }

    const { data: publicUrlData } = supabaseClient
      .storage
      .from('images')
      .getPublicUrl(filePath);

    imageUrl = publicUrlData.publicUrl;
  }

  if (content) {
    const { error: upsertError } = await supabaseClient
      .from('diary_entries')
      .upsert(
        {
          date: dateKey,
          text: content,
          color: color,
          email: recipientEmail,
          email_sent: false,
          image_url: imageUrl,
          title: title,
          remarks: remarks,
          subject: subject
        },
        { onConflict: 'date' }
      );

    if (upsertError) {
      console.error("Insert/Update error:", upsertError.message);
      return alert("‚ùå Error saving note: " + upsertError.message);
    }

    // ‚úÖ Send email via Edge Function if recipientEmail is provided
    if (recipientEmail) {
      try {
        const res = await fetch('/api/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date: dateKey, text: content, color, recipientEmail, imageUrl, title, remarks, subject }),
        });

        if (res.ok) {
          // Mark as sent
          await supabaseClient
            .from('diary_entries')
            .update({ email_sent: true })
            .eq('date', dateKey);

          showModal('emailSuccessModal'); // ‚úÖ Show success modal
        } else {
          showModal('emailFailModal'); // ‚ùå Show failure modal
        }
      } catch (e) {
        console.error("‚ùå Email send failed", e);
        showModal('emailFailModal');
      }
    }

  } else {
    // ‚ùå Delete note if content is empty
    const { error: delError } = await supabaseClient
      .from('diary_entries')
      .delete()
      .eq('date', dateKey);

    if (delError) {
      console.error("Delete error:", delError);
      return alert("‚ùå Error deleting note.");
    }
  }

  noteEditor.style.display = 'none';
  document.getElementById('emailRecipient').value = '';
  showSaveModal();
  await renderCalendar();
}


function showSaveModal() {
  const modal = document.getElementById('saveModal');
  modal.style.display = 'block';

  setTimeout(() => {
    modal.style.display = 'none';
  }, 2000); // hides after 2 seconds
}

function showModal(modalId) {
  const modal = document.getElementById(modalId);
  modal.style.display = 'block';
  setTimeout(() => {
    modal.style.display = 'none';
  }, 2000);
}





  function formatDateKey(y, m, d) {
    return `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
  }

  monthSelect.onchange = renderCalendar;
  yearSelect.onchange = renderCalendar;
  filterSelect.onchange = renderCalendar;
  searchInput.oninput = renderCalendar;

  renderCalendar();
</script>

</body>
</html>
