<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üìñ Full Calendar Diary</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: 'Courier New', monospace;
      background: #f3e9dc;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    h1 {
      color: #4e342e;
    }

    .controls {
      margin: 10px 0;
    }

    select, input[type="text"] {
      font-family: inherit;
      font-size: 16px;
      padding: 5px 10px;
      margin: 0 5px;
    }

    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      width: 100%;
      max-width: 700px;
      margin-bottom: 30px;
    }

    .day, .day-name {
      padding: 10px;
      background: #fff8dc;
      border: 1px solid #c4b89b;
      text-align: center;
      min-height: 80px;
      cursor: pointer;
      box-sizing: border-box;
    }

    .day-name {
      background: #e5d3b3;
      font-weight: bold;
      cursor: default;
    }

    .day:hover {
      background: #fceacb;
    }

    .has-note {
      font-weight: bold;
    }

    .today {
      border: 2px solid #d2691e;
    }

    .note-editor {
      background: #fff8dc;
      border: 1px solid #c4b89b;
      padding: 20px;
      width: 100%;
      max-width: 700px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }

    .note-editor h2 {
      margin-top: 0;
    }

    textarea {
      width: 100%;
      height: 150px;
      margin: 10px 0;
      resize: vertical;
      font-family: inherit;
      font-size: 16px;
      background: transparent;
      border: 1px solid #d2b48c;
      padding: 10px;
      line-height: 1.5;
    }

    button {
      background: #d2b48c;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      font-family: inherit;
      cursor: pointer;
      border-radius: 5px;
    }

    button:hover {
      background: #bca27d;
    }

    .work {
      background-color: #ffe4e1 !important;
    }

    .personal {
      background-color: #e0ffff !important;
    }

    .important {
      background-color: #ffffe0 !important;
    }
  </style>
</head>
<body>

<h1>üìñ My Calendar Diary</h1>

<div class="controls">
  <select id="monthSelect"></select>
  <select id="yearSelect"></select>
  <select id="filterSelect">
    <option value="">Filter by type</option>
    <option value="work">Work</option>
    <option value="personal">Personal</option>
    <option value="important">Important</option>
  </select>
  <input type="text" id="searchInput" placeholder="Search notes...">
</div>

<div class="calendar" id="calendar"></div>

<div class="note-editor" id="noteEditor" style="display:none;">
  <h2 id="noteTitle">Diary Entry</h2>
  <select id="noteType">
    <option value="">None</option>
    <option value="work">Work</option>
    <option value="personal">Personal</option>
    <option value="important">Important</option>
  </select>

  <textarea id="noteContent" placeholder="Write your thoughts..."></textarea>

  <input type="email" id="emailRecipient" placeholder="Recipient email (optional)" style="width:100%; margin: 10px 0; font-family: inherit; font-size: 16px; padding: 10px; border: 1px solid #d2b48c; background: transparent;">

  
  <button onclick="saveNote()">Save</button>
</div>

<!-- Supabase CDN -->
<script>
  const supabaseUrl = 'https://rushdtpzxfnvobniswwm.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1c2hkdHB6eGZudm9ibmlzd3dtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzNjQ5OTUsImV4cCI6MjA2MTk0MDk5NX0.r9saS6lbP_rckgZboDg_bJd2Hy1VqfLEwS0k0AT07lE';
  const supabaseClient  = supabase.createClient(supabaseUrl, supabaseKey);

  const calendarEl = document.getElementById('calendar');
  const noteEditor = document.getElementById('noteEditor');
  const noteTitle = document.getElementById('noteTitle');
  const noteContent = document.getElementById('noteContent');
  const monthSelect = document.getElementById('monthSelect');
  const yearSelect = document.getElementById('yearSelect');
  const filterSelect = document.getElementById('filterSelect');
  const searchInput = document.getElementById('searchInput');
  const noteType = document.getElementById('noteType');

  const months = ["January", "February", "March", "April", "May", "June",
                  "July", "August", "September", "October", "November", "December"];
  const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

  for (let i = 0; i < 12; i++) {
    const opt = document.createElement('option');
    opt.value = i;
    opt.text = months[i];
    monthSelect.appendChild(opt);
  }

  const currentYear = new Date().getFullYear();
  for (let i = currentYear - 50; i <= currentYear + 50; i++) {
    const opt = document.createElement('option');
    opt.value = i;
    opt.text = i;
    yearSelect.appendChild(opt);
  }

  const today = new Date();
  monthSelect.value = today.getMonth();
  yearSelect.value = today.getFullYear();

  async function renderCalendar() {
  calendarEl.innerHTML = '';
  const year = parseInt(yearSelect.value);
  const month = parseInt(monthSelect.value);
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const lastDay = daysInMonth; // ‚úÖ use real last day

  const filter = filterSelect.value;
  const searchTerm = searchInput.value.toLowerCase();

  const { data: notes, error } = await supabaseClient
    .from('diary_entries')
    .select('*')
    .gte('date', `${year}-${String(month + 1).padStart(2, '0')}-01`)
    .lte('date', `${year}-${String(month + 1).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`);

  if (error) {
    console.error("Failed to load notes:", error);
    return;
  }

  const now = new Date();
  const utc = now.getTime() + now.getTimezoneOffset() * 60000;
  const phNow = new Date(utc + 8 * 60 * 60 * 1000);
  const phYear = phNow.getFullYear();
  const phMonth = phNow.getMonth();
  const phDay = phNow.getDate();

  // Day headers
  daysOfWeek.forEach(day => {
    const header = document.createElement('div');
    header.className = 'day-name';
    header.textContent = day;
    calendarEl.appendChild(header);
  });

  // Blank cells before 1st day
  for (let i = 0; i < firstDay; i++) {
    const blank = document.createElement('div');
    calendarEl.appendChild(blank);
  }

  // Render each day
  for (let day = 1; day <= daysInMonth; day++) {
    const dateKey = formatDateKey(year, month, day);
    const noteData = notes.find(n => n.date === dateKey);
    const noteText = noteData?.text?.toLowerCase() || '';
    const noteColor = noteData?.color || '';

    let showNote = true;
    if ((filter && noteColor !== filter) || (searchTerm && !noteText.includes(searchTerm))) {
      showNote = false;
    }

    const cell = document.createElement('div');
    cell.className = 'day';
    cell.innerHTML = `<strong>${day}</strong>`;

    if (noteText && showNote) {
      cell.innerHTML += `<br><span style="font-size: 20px;">üìù</span>`;
      cell.classList.add('has-note');
      if (noteColor) cell.classList.add(noteColor);
    }

    if (year === phYear && month === phMonth && day === phDay) {
      cell.classList.add('today');
    }

    cell.onclick = () => openNote(year, month, day, noteData);
    calendarEl.appendChild(cell);
  }
}


  function openNote(year, month, day, noteData = null) {
    const dateKey = formatDateKey(year, month, day);
    noteContent.value = noteData?.text || '';
    noteType.value = noteData?.color || '';
    noteEditor.style.display = 'block';
    noteTitle.textContent = `Diary - ${months[month]} ${day}, ${year}`;
    noteEditor.setAttribute('data-date', dateKey);
  }
  

  async function saveNote() {
  const dateKey = noteEditor.getAttribute('data-date');
  const content = noteContent.value.trim();
  const color = noteType.value;
  const recipientEmail = document.getElementById('emailRecipient').value.trim();  // Capture the email input

  if (content) {
    const { error: upsertError } = await supabaseClient
      .from('diary_entries')
      .upsert({ date: dateKey, text: content, color: color, email_sent: false });

    if (upsertError) {
      console.error("Insert/Update error:", upsertError);
      return alert("‚ùå Error saving note.");
    }

    // Send email via Edge Function if a recipient email is provided
    if (recipientEmail) {
      try {
        const res = await fetch('/api/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date: dateKey, text: content, color, recipientEmail }),  // Send recipient email in the body
        });

        if (res.ok) {
          // Mark note as email_sent = true
          await supabaseClient
            .from('diary_entries')
            .update({ email_sent: true })
            .eq('date', dateKey);
        }
      } catch (e) {
        console.error("‚ùå Email send failed", e);
      }
    }

  } else {
    const { error: delError } = await supabaseClient
      .from('diary_entries')
      .delete()
      .eq('date', dateKey);

    if (delError) {
      console.error("Delete error:", delError);
      return alert("‚ùå Error deleting note.");
    }
  }

  noteEditor.style.display = 'none';
  document.getElementById('emailRecipient').value = '';
  await renderCalendar();
}



  function formatDateKey(y, m, d) {
    return `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
  }

  monthSelect.onchange = renderCalendar;
  yearSelect.onchange = renderCalendar;
  filterSelect.onchange = renderCalendar;
  searchInput.oninput = renderCalendar;

  renderCalendar();
</script>

</body>
</html>
