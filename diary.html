<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:site_name" content="Hello, Rosaura Meowie!">
    <meta property="og:title" content="Hello, Rosaura Meowie!" />
    <meta property="og:description" content="A special letter for someone special!" />
    <meta property="og:image" content="/pink.png" />
    <meta property="og:url" content="https://rosaura-letter.vercel.app/diary.html" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Hello, Rosaura Meowie!" />
    <meta name="twitter:description" content="A special letter for someone special!" />
    <meta name="twitter:image" content="/pink.png/" /> 
    <link rel="icon" href="pink.png" type="image/png">
    <title>Hello, Rosaura Meowie!</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Courier New', monospace;
      background: #f3e9dc;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    h1 {
      color: #4e342e;
    }
.controls {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
}

@media (max-width: 600px) {
  .controls {
    flex-direction: column;
    align-items: stretch;
  }

  .month-year-group {
    display: flex;
    flex-direction: row;
    gap: 10px;
    width: 100%;
  }

  .month-year-group select {
    flex: 1;
    font-size: 16px;
    padding: 10px;
    box-sizing: border-box;
  }

  #filterSelect,
  #searchInput {
    width: 100%;
    box-sizing: border-box;
    font-size: 16px;
    padding: 10px;
  }
}
    select, input[type="text"] {
      font-family: inherit;
      font-size: 16px;
      padding: 5px 10px;
      margin: 0 5px;
    }

    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      width: 100%;
      max-width: 700px;
      margin-bottom: 30px;
    }

    .day, .day-name {
      padding: 10px;
      background: #fff8dc;
      border: 1px solid #c4b89b;
      text-align: center;
      min-height: 100px;
      cursor: pointer;
      box-sizing: border-box;
      overflow: hidden;       
      max-height: 100px;        
    }

    .day-name {
      background: #e5d3b3;
      font-weight: bold;
      cursor: default;
    }

    .day:hover {
      background: #fceacb;
    }

    .has-note {
      font-weight: bold;
    }

    .today {
      border: 2px solid #000000;
    }

    .note-editor {
      background: #fff8dc;
      border: 1px solid #c4b89b;
      padding: 20px;
      width: 100%;
      max-width: 700px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }

     .note-title {
      white-space: nowrap;       
      overflow: hidden;           
      text-overflow: ellipsis;    
      max-width: 100%;            
      text-align: center;        
      line-height: 20px;          
      display: inline-block;     
      height: 20px;               
      width: 100%;           
    }


    .note-editor h2 {
      margin-top: 0;
    }

    textarea {
      width: 100%;
      height: 150px;
      margin: 10px 0;
      resize: vertical;
      font-family: inherit;
      font-size: 16px;
      background: transparent;
      border: 1px solid #d2b48c;
      padding: 10px;
      line-height: 1.5;
    }

    .form-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 10px;
      flex-wrap: wrap; 
    }

    #noteImage {
      margin: 10px 0;
      font-family: inherit;
      flex-grow: 1;
      max-width: 70%; 
    }

    .button-container {
      display: flex;
      gap: 10px; 
    }

    button {
      background: #d2b48c;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      font-family: inherit;
      cursor: pointer;
      border-radius: 5px;
    }

@media (max-width: 600px) {
  .form-container {
    flex-direction: column; 
    align-items: stretch; 
  }

  #noteImage {
    width: 100%; 
    margin-bottom: 10px;
  }

  .button-container {
    width: 100%; 
    justify-content: space-evenly; 
  }

  button {
    width: 45%; 
    padding: 12px 20px; 
    font-size: 14px;
  }
}

    button.save {
      float: right;
    }

    button.clear {
      float: left;
    }

    button:hover {
      background: #bca27d;
    }

    .love {
      background-color: #e1589f !important;
    }

    .important {
      background-color: #c9604b !important;
    }

    .greetings {
      background-color: #7464d9 !important;
    }
    .controls select, .controls input {
    font-size: 14 px;
  }
  
  .outlined-input {
  position: relative;
  margin: 30px 0;
  width: 250px;
}

.outlined-input input {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  border: 1px solid;
  border-radius: 8px;
  outline: none;
  background: transparent;
  color: #333;
}

.outlined-input label {
  position: absolute;
  top: -10px;
  left: 12px;
  background: white;
  padding: 0 5px;
  color: #5d00ff;
  font-size: 14px;
  font-weight: 500;
}

/* --------- üåô Dark Mode --------- */
body.dark-mode {
  background-color: #121212;
  color: #f3f3f3;
}

body.dark-mode .calendar .day.today {
  border-color: #ffffff !important;
}

body.dark-mode .calendar .day,
body.dark-mode .calendar .day-name,
body.dark-mode .note-editor,
body.dark-mode select,
body.dark-mode input,
body.dark-mode textarea {
  background-color: #1e1e1e;
  color: #f3f3f3;
  border-color: #555;
}

body.dark-mode .day:hover {
  background-color: #2c2c2c;
}

body.dark-mode button {
  background-color: #444;
  color: #fff;
}

body.dark-mode button:hover {
  background-color: #666;
}

body.dark-mode #saveModal,
body.dark-mode #emailSuccessModal,
body.dark-mode #emailFailModal {
  background-color: #222;
  color: #fff;
}


/* --------- üåô Toggle Switch --------- */
.theme-toggle {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 10000;
}

.switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 26px;
}

.switch input {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
  z-index: 3;
  cursor: pointer;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: 0.4s;
  border-radius: 34px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 6px;
  font-size: 14px;
  box-sizing: border-box;
}

.slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.4s;
  border-radius: 50%;
  z-index: 2;
}

input:checked + .slider {
  background-color: #666;
}

input:checked + .slider:before {
  transform: translateX(24px);
}

.slider .icon {
  opacity: 0.3;
  transition: opacity 0.3s ease;
  z-index: 1;
}

input:checked + .slider .moon {
  opacity: 1;
}

input:not(:checked) + .slider .sun {
  opacity: 1;
}

#floatingMessage {
  position: fixed;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 24px;
  font-weight: bold;
  pointer-events: none;
  opacity: 0;
  animation: none;
  z-index: 9999;
  color: white; /* default for dark mode */
}

body:not(.dark-mode) #floatingMessage {
  color: black;
}

@keyframes floatUp {
  0% {
    opacity: 0;
    transform: translate(-50%, 20px);
  }
  10% {
    opacity: 1;
    transform: translate(-50%, 0);
  }
  90% {
    opacity: 1;
    transform: translate(-50%, -60px);
  }
  100% {
    opacity: 0;
    transform: translate(-50%, -80px);
  }
}



  </style>
</head>
<body>

  <center>
    <h1 style="margin: 0; line-height: 1.2; margin-top: 20px;">üìñ Dear Saura ·∞î</h1>
    <small style="display: block; margin: 0; font-size: 0.9em; margin-bottom: 15px;">Developed by: Martel</small>
  </center> 

  <div class="controls" style="margin-bottom: 25px;">
    <div class="month-year-group">
      <select id="monthSelect"></select>
      <select id="yearSelect"></select>
    </div>
    <select id="filterSelect">
      <option value="">Filter by theme</option>
      <option value="important">Important</option>
      <option value="love">Love</option>
      <option value="greetings">Greetings</option>
    </select>
    <input type="text" id="searchInput" placeholder="Search notes...">
  </div>

  
  <div class="theme-toggle">
    <label class="switch">
      <input type="checkbox" id="themeSwitch">
      <span class="slider">
        <span class="icon sun">‚òÄÔ∏è</span>
        <span class="icon moon">üåô</span>
      </span>
    </label>
  </div>
  
  <!-- Light Mode Song -->
  <audio id="sunAudio" preload="auto" loop>
    <source src="youllbeinmyheart.mp3" type="audio/mp3">
    Your browser does not support the audio element.
  </audio>
  
  <!-- Dark Mode Song -->
  <audio id="moonAudio" preload="auto" loop>
    <source src="sabawatsandali.mp3" type="audio/mp3">
    Your browser does not support the audio element.
  </audio>

  <div id="floatingMessage"></div>
  

<div class="calendar" id="calendar"></div>
<div class="note-editor" id="noteEditor" style="display:none;">

<img id="noteImagePreview" src="" alt="Note Image" style="max-width:100%; height:auto; max-height:200px;  display: block; object-fit:cover; float: right;  display:none; margin-bottom:10px; border: 2px solid #ccc; border-radius: 8px;">

  <h2 id="noteTitle">Diary Entry</h2>

  <label for="noteType" style="display:block; margin-top:10px;">Theme:</label>
  <select id="noteType" style="font-family: inherit; font-size: 16px; padding: 5px;">
    <option value="">None</option>
    <option value="important">Important</option>
    <option value="love">Love</option>
    <option value="greetings">Greetings</option>
  </select>

  <label for="mood" style="display:block; margin-top:10px;">Mood:</label>
<select id="mood" style="font-family: inherit; font-size: 16px; padding: 5px;">
  <option value="">Select Mood</option>
  <option value="üòä">üòä Happy</option>
  <option value="üò¢">üò¢ Sad</option>
  <option value="üò≠">üò≠ Crying</option>
  <option value="üò°">üò° Angry</option>
  <option value="ü§≠">ü§≠ Embarrassed</option>
  <option value="üò¥">üò¥ Tired</option>
  <option value="üòç">üòç In Love</option>
  <option value="ü§î">ü§î Thoughtful</option>
  <option value="üòé">üòé Cool</option>
</select>

<label for="subject" style="display:block; margin-top:20px;">Subject:</label>
  <input type="text" id="subject" placeholder="..." style="width:95%; margin: 10px 0; font-family: inherit; font-size: 16px; padding: 10px; border: 1px solid #d2b48c; background: transparent;">

  <label for="subject" style="display:block; margin-top:10px;">Title:</label>
  <input type="text" id="title" placeholder="..." style="width:95%; margin: 10px 0; font-family: inherit; font-size: 16px; padding: 10px; border: 1px solid #d2b48c; background: transparent;">

  <textarea id="noteContent" placeholder="Write your thoughts..." style="width:95%;"></textarea>

  <label for="remarks" style="display:block; margin-top:10px;">Remarks:</label>
  <input type="text" id="remarks" placeholder="..." style="width:95%; margin: 10px 0; font-family: inherit; font-size: 16px; padding: 10px; border: 1px solid #d2b48c; background: transparent;">

  <label for="from" style="display:block; margin-top:10px;">From:</label>
  <input type="text" id="from" placeholder="..." style="width:95%; margin: 10px 0; font-family: inherit; font-size: 16px; padding: 10px; border: 1px solid #d2b48c; background: transparent;">

  <label for="emailRecipient" style="display:block; margin-top:10px;">Recipient Email: (optional)</label>
  <input type="email" id="emailRecipient" placeholder="..." style="width:95%; margin: 10px 0; font-family: inherit; font-size: 16px; padding: 10px; border: 1px solid #d2b48c; background: transparent;">

  <div class="form-container">

    <input type="file" id="noteImage" accept="image/*" style="margin: 10px 0; font-family: inherit;">
  
    <div class="button-container">
      <button class="save" onclick="saveNote()">Save</button>
      <button class="clear" onclick="clearNote()">Clear</button>
    </div>
  </div>

</div>

<div id="saveModal" style="
  display: none;
  position: fixed;
  top: 20px; /* ‚¨ÖÔ∏è Changed from bottom to top */
  left: 50%;
  transform: translateX(-50%);
  background-color: #333;
  color: #fff;
  padding: 10px 20px;
  border-radius: 8px;
  z-index: 9999;
  opacity: 0.95;
  font-family: sans-serif;  
">
  ‚úÖ Note saved successfully!
</div>

<div id="emailSuccessModal" style="
  display: none;
  position: fixed;
  top: 65px; /* ‚¨ÖÔ∏è Changed from bottom to top */
  left: 50%;
  transform: translateX(-50%);
  background-color: #333;
  color: #fff;
  padding: 10px 20px;
  border-radius: 8px;
  z-index: 9999;
  opacity: 0.95;
  font-family: sans-serif;
">
  ‚úâÔ∏è Email sent successfully!
</div>

<div id="emailFailModal" style="
  display: none;
  position: fixed;
  top: 65px; /* ‚¨ÖÔ∏è Changed from bottom to top */
  left: 50%;
  transform: translateX(-50%);
  background-color: #333;
  color: #fff;
  padding: 10px 20px;
  border-radius: 8px;
  z-index: 9999;
  opacity: 0.95;
  font-family: sans-serif;
">
  ‚ùå Failed to send email.
</div>


<script>
  
  function showFloatingMessage(text) {
  const msg = document.getElementById('floatingMessage');
  msg.textContent = text;
  msg.style.animation = 'none'; // Reset animation
  msg.offsetHeight; // Force reflow
  msg.style.animation = 'floatUp 2s ease forwards';
}

  // Wait until the page has fully loaded before executing the code
  window.addEventListener('DOMContentLoaded', function () {
    const themeSwitch = document.getElementById('themeSwitch');
    const sunIcon = document.querySelector('.slider .sun');
    const moonIcon = document.querySelector('.slider .moon');

    // Retrieve the saved theme from localStorage
    const savedTheme = localStorage.getItem('theme');
    console.log('Saved theme from localStorage:', savedTheme); // Debug log to check what's in localStorage

    if (savedTheme === 'dark') {
      document.body.classList.add('dark-mode');
      if (themeSwitch) themeSwitch.checked = true; // Check the switch if the theme is dark
    }

    updateIcons();

    if (themeSwitch) {
      themeSwitch.addEventListener('change', () => {
        document.body.classList.toggle('dark-mode');
        // Save the current theme to localStorage
        const currentTheme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
        localStorage.setItem('theme', currentTheme);
        console.log('Theme saved to localStorage:', currentTheme); // Debug log to confirm saving
        updateIcons();

         // Play the respective song when theme is toggled
        if (document.body.classList.contains('dark-mode')) {
          playMoonSong(); // Play the moon song for dark mode
          showFloatingMessage("I miss you üòî");
        } else {
          playSunSong(); // Play the sun song for light mode
          showFloatingMessage("I love you üòò");
        }
        
      });
    }

    function updateIcons() {
      if (sunIcon && moonIcon) {
        if (document.body.classList.contains('dark-mode')) {
          sunIcon.style.opacity = '0.3';
          moonIcon.style.opacity = '1';
        } else {
          sunIcon.style.opacity = '1';
          moonIcon.style.opacity = '0.3';
        }
      }
    }

  function playSunSong() {
    moonAudio.pause(); 
    sunAudio.play();  
  }

  function playMoonSong() {
    sunAudio.pause();  
    moonAudio.play();  
  }
  });

</script>

<!-- Supabase CDN -->
<script>
  const supabaseUrl = 'https://rushdtpzxfnvobniswwm.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1c2hkdHB6eGZudm9ibmlzd3dtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzNjQ5OTUsImV4cCI6MjA2MTk0MDk5NX0.r9saS6lbP_rckgZboDg_bJd2Hy1VqfLEwS0k0AT07lE';
  const supabaseClient  = supabase.createClient(supabaseUrl, supabaseKey);

  const calendarEl = document.getElementById('calendar');
  const noteEditor = document.getElementById('noteEditor');
  const noteTitle = document.getElementById('noteTitle');
  const noteContent = document.getElementById('noteContent');
  const monthSelect = document.getElementById('monthSelect');
  const yearSelect = document.getElementById('yearSelect');
  const filterSelect = document.getElementById('filterSelect');
  const searchInput = document.getElementById('searchInput');
  const noteType = document.getElementById('noteType');

  const months = ["January", "February", "March", "April", "May", "June",
                  "July", "August", "September", "October", "November", "December"];
  const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

  for (let i = 0; i < 12; i++) {
    const opt = document.createElement('option');
    opt.value = i;
    opt.text = months[i];
    monthSelect.appendChild(opt);
  }

  const currentYear = new Date().getFullYear();
  for (let i = currentYear - 50; i <= currentYear + 50; i++) {
    const opt = document.createElement('option');
    opt.value = i;
    opt.text = i;
    yearSelect.appendChild(opt);
  }

  const today = new Date();
  monthSelect.value = today.getMonth();
  yearSelect.value = today.getFullYear();

  function clearNote() {
  noteContent.value = '';
  noteType.value = '';
  document.getElementById('emailRecipient').value = '';
  document.getElementById('remarks').value = '';
  document.getElementById('subject').value = '';
  document.getElementById('title').value = '';
  document.getElementById('mood').value = '';
  document.getElementById('from').value = '';

  const preview = document.getElementById('noteImagePreview');
  preview.style.display = 'none';
  preview.src = '';

  const fileInput = document.getElementById('noteFileInput');
  if (fileInput) {
    fileInput.value = '';
  }
}


function isMobileView() {
  return window.innerWidth <= 900; 
}

async function getUserIpAddress() {
  try {
    const response = await fetch('https://api.ipify.org?format=json');
    const data = await response.json();
    return data.ip;  
  } catch (error) {
    console.error("Error fetching IP address:", error);
  }
}

async function trackView(ipAddress, noteId) {
  const formatter = new Intl.DateTimeFormat('sv-SE', {
    timeZone: 'Asia/Manila',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false,
  });

  const parts = formatter.formatToParts(new Date());
  const p = Object.fromEntries(parts.map(({ type, value }) => [type, value]));

  const viewedAt = `${p.year}-${p.month}-${p.day}T${p.hour}:${p.minute}:${p.second}`;

  const { data, error } = await supabaseClient
    .from('note_views')
    .insert([{ note_id: noteId, ip_address: ipAddress, viewed_at: viewedAt }]);

  if (error) {
    console.error('Error logging view:', error);
  }
}

  async function renderCalendar() {
  calendarEl.innerHTML = '';
  const year = parseInt(yearSelect.value);
  const month = parseInt(monthSelect.value);
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const lastDay = daysInMonth; // ‚úÖ use real last day

  const filter = filterSelect.value;
  const searchTerm = searchInput.value.toLowerCase();

  const { data: notes, error } = await supabaseClient
    .from('diary_entries')
    .select('*')
    .gte('date', `${year}-${String(month + 1).padStart(2, '0')}-01`)
    .lte('date', `${year}-${String(month + 1).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`);

  if (error) {
    console.error("Failed to load notes:", error);
    return;
  }

  const now = new Date();
  const utc = now.getTime() + now.getTimezoneOffset() * 60000;
  const phNow = new Date(utc + 8 * 60 * 60 * 1000);
  const phYear = phNow.getFullYear();
  const phMonth = phNow.getMonth();
  const phDay = phNow.getDate();

  // Day headers
  daysOfWeek.forEach(day => {
    const header = document.createElement('div');
    header.className = 'day-name';
    header.textContent = day;
    calendarEl.appendChild(header);
  });

  // Blank cells before 1st day
  for (let i = 0; i < firstDay; i++) {
    const blank = document.createElement('div');
    calendarEl.appendChild(blank);
  }

  // Render each day
  for (let day = 1; day <= daysInMonth; day++) {
    const dateKey = formatDateKey(year, month, day);
    const noteData = notes.find(n => n.date === dateKey);
    const noteText = noteData?.text?.toLowerCase() || '';
    const noteColor = noteData?.color || '';

    let showNote = true;
    if ((filter && noteColor !== filter) || (searchTerm && !noteText.includes(searchTerm))) {
      showNote = false;
    }

    const cell = document.createElement('div');
    cell.className = 'day';
    cell.innerHTML = `<strong>${day}</strong>`;
    cell.setAttribute('data-date', dateKey); 

    if (noteText && showNote) {
  // cell.innerHTML += `<br><span style="font-size: 20px;">üìù</span>`;
  cell.innerHTML += `<div style="font-size: 18px;">${noteData.mood}</div>`;
  if (noteData.title) {

    cell.innerHTML += `<div class="note-title" style="font-size: 12px; margin-top: 4px;">${noteData.title}</div>`;
  }
  cell.classList.add('has-note');
  if (noteColor) cell.classList.add(noteColor);
}


    if (year === phYear && month === phMonth && day === phDay) {
      cell.classList.add('today');
    }

    cell.onclick = () => openNote(year, month, day, noteData);
    calendarEl.appendChild(cell);
  }
}

  async function openNote(year, month, day, noteData = null) {
    const dateKey = formatDateKey(year, month, day);
    noteContent.value = noteData?.text || '';
    noteType.value = noteData?.color || '';
    noteEditor.style.display = 'block';
    noteTitle.textContent = `Diary - ${months[month]} ${day}, ${year}`;
    noteEditor.setAttribute('data-date', dateKey);

  const ipAddress = await getUserIpAddress();

  await trackView(ipAddress, noteData?.id); 

  const preview = document.getElementById('noteImagePreview');
  document.getElementById('title').value = noteData?.title || '';

  document.getElementById('remarks').value = noteData?.remarks || '';

  document.getElementById('subject').value = noteData?.subject || '';

  document.getElementById('mood').value = noteData?.mood || '';

  document.getElementById('from').value = noteData?.from || '';

  if (noteData?.image_url) {
    preview.src = noteData.image_url;
    preview.style.display = 'block';
  } else {
    preview.style.display = 'none'; 
    preview.src = '';
  }

    // If an email is present, set it as the value of the emailRecipient input
    if (noteData?.email) {
        document.getElementById('emailRecipient').value = noteData.email;
    } else {
        document.getElementById('emailRecipient').value = ''; 
    }

       // If on mobile, scroll to the selected day and focus on the note editor
  if (isMobileView()) {
    setTimeout(() => {
 
      const dayCell = document.querySelector(`.day[data-date="${dateKey}"]`);
      if (dayCell) {

        dayCell.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      noteEditor.scrollIntoView({ behavior: 'smooth', block: 'start' });
      noteEditor.focus();
    }, 300); 
  }
  }

  async function getNoteViews(noteId) {
  try {
    console.log('Fetching views for noteId:', noteId);

    const { data, error } = await supabaseClient
      .from('note_views')
      .select('*')
      .eq('note_id', noteId)
      .throwOnError();

    console.log('Note Views:', data);
  } catch (err) {
    console.error('Supabase fetch error:', err);
  }
}
  async function saveNote() {  

  const dateKey = noteEditor.getAttribute('data-date');
  const content = noteContent.value.trim();
  const color = noteType.value;
  const recipientEmail = document.getElementById('emailRecipient').value.trim(); 
  const imageFile = document.getElementById('noteImage').files[0];
  const title = document.getElementById('title').value.trim();  
  const remarks = document.getElementById('remarks').value.trim();
  const subject = document.getElementById('subject').value.trim();
  const mood = document.getElementById('mood').value;
  const from = document.getElementById('from').value;
  

  const dateCreatedPHT = new Date().toLocaleString("en-PH", { timeZone: "Asia/Manila" });


   // ‚úÖ Fetch existing note (must come AFTER dateKey is defined)
   let { data: existingNote, error: fetchError } = await supabaseClient
    .from('diary_entries')
    .select('image_url')
    .eq('date', dateKey)
    .maybeSingle();

  if (fetchError && fetchError.code !== 'PGRST116') {
    console.error("Error fetching existing note:", fetchError.message);
  }

  let imageUrl = existingNote?.image_url || '';

  // ‚úÖ Upload image if file selected
  if (imageFile) {
    const fileExt = imageFile.name.split('.').pop();
    const fileName = `${dateKey}.${fileExt}`;
    // const filePath = `diary-images/${dateKey}-${imageFile.name}`;
    const filePath = `images/${dateKey}-${imageFile.name}`; // ‚Üê matches upload path

    const { error: uploadError } = await supabaseClient.storage
    .from('images')
  .upload(filePath, imageFile, {
    cacheControl: '3600',
    upsert: true,
    contentType: imageFile.type,
  });

    if (uploadError) {
      console.error("‚ùå Image upload failed:", uploadError);
      return alert("‚ùå Image upload failed: " + uploadError.message);
    }

    const { data: publicUrlData } = supabaseClient
      .storage
      .from('images')
      .getPublicUrl(filePath);

    imageUrl = publicUrlData.publicUrl;
  }

  if (content) {
    const { error: upsertError } = await supabaseClient
      .from('diary_entries')
      .upsert(
        {
          date: dateKey,
          text: content,
          color: color,
          email: recipientEmail,
          email_sent: false,
          image_url: imageUrl,
          title: title,
          remarks: remarks,
          subject: subject,
          mood: mood,
          from: from,
          date_created: dateCreatedPHT 
        },
        { onConflict: 'date' }
      );

    if (upsertError) {
      console.error("Insert/Update error:", upsertError.message);
      return alert("‚ùå Error saving note: " + upsertError.message);
    }

    // ‚úÖ Send email via Edge Function if recipientEmail is provided
    if (recipientEmail) {
      try {
        const res = await fetch('/api/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date: dateKey, text: content, color, recipientEmail, imageUrl, title, remarks, subject, mood, from }),
        });

        if (res.ok) {
          // Mark as sent
          await supabaseClient
            .from('diary_entries')
            .update({ email_sent: true })
            .eq('date', dateKey);

          showModal('emailSuccessModal'); 
        } else {
          showModal('emailFailModal'); 
        }
      } catch (e) {
        console.error("‚ùå Email send failed", e);
        showModal('emailFailModal');
      }
    }

    const fileInput = document.getElementById('noteFileInput');
  if (fileInput) {
    fileInput.value = '';
  }

} else {
  const { data: noteToDelete, error: fetchNoteError } = await supabaseClient
    .from('diary_entries')
    .select('id')
    .eq('date', dateKey)
    .maybeSingle();

  if (fetchNoteError || !noteToDelete?.id) {
    console.error("Could not fetch note:", fetchNoteError?.message);
    return alert("‚ùå Could not find note to delete.");
  }

  const noteId = noteToDelete.id;
  console.log("Attempting delete for noteId:", noteId);

  // Delete related note_views
  const { error: viewsDeleteError } = await supabaseClient
    .from('note_views')
    .delete()
    .eq('note_id', noteId);

  if (viewsDeleteError) {
    console.error("View delete failed:", viewsDeleteError.message);
    return alert("‚ùå Failed to delete views.");
  }

  // Delete the diary entry
  const { error: delError } = await supabaseClient
    .from('diary_entries')
    .delete()
    .eq('id', noteId);

  if (delError) {
    console.error("Note delete failed:", delError.message);
    return alert("‚ùå Failed to delete note.");
  }
}

  noteEditor.style.display = 'none';
  document.getElementById('emailRecipient').value = '';
  showSaveModal();
  await renderCalendar();
}


function showSaveModal() {
  const modal = document.getElementById('saveModal');
  modal.style.display = 'block';

  setTimeout(() => {
    modal.style.display = 'none';
  }, 2000); // hides after 2 seconds
}

function showModal(modalId) {
  const modal = document.getElementById(modalId);
  modal.style.display = 'block';
  setTimeout(() => {
    modal.style.display = 'none';
  }, 2000);
}

  function formatDateKey(y, m, d) {
    return `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
  }

  monthSelect.onchange = renderCalendar;
  yearSelect.onchange = renderCalendar;
  filterSelect.onchange = renderCalendar;
  searchInput.oninput = renderCalendar;
  renderCalendar();

</script>
</body>
</html>
